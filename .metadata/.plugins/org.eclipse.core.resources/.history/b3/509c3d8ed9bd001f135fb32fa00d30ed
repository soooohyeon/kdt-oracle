
-- 연관 서브쿼리 : 서브쿼리를 독립적으로 사용 가능
-- 최대 급여를 받는 직원 조회
SELECT EMPlOYEE_ID, FIRST_NAME, SALARY
FROM EMPLOYEES
WHERE SALARY = (SELECT MAX(SALARY) FROM EMPLOYEES);

-- 비연관 서브쿼리 : 서브쿼리를 독립적으로 사용 불가 - 메인과 서브쿼리간의 비교로 독립 불가
-- 각 직원의 급여가 부서별 평균 급여보다 높은 직원 조회
SELECT EMPLOYEE_ID, FIRST_NAME, SALARY, DEPARTMENT_ID
FROM EMPLOYEES E
WHERE SALARY > (SELECT AVG(SALARY)
	FROM EMPLOYEES
	WHERE DEPARTMENT_ID = E.DEPARTMENT_ID)
ORDER BY E.DEPARTMENT_ID;


SELECT DEPARTMENT_ID, AVG(SALARY)
FROM EMPLOYEES
GROUP BY DEPARTMENT_ID
ORDER BY DEPARTMENT_ID ;

-- 단일행 서브쿼리(서브쿼리의 결과가 하나의 행만 반환)
-- 가장 오래된 입사일을 가진 직원의 사원번호, 이름, 입사일 조회
SELECT * FROM EMPLOYEES
ORDER BY HIRE_DATE;

SELECT EMPLOYEE_ID, FIRST_NAME, HIRE_DATE
FROM EMPLOYEES
WHERE HIRE_DATE = (SELECT MIN(HIRE_DATE) FROM EMPLOYEES);

-- 다중행 서브쿼리(서브쿼리의 결과가 여러행을 반환)
-- 특정 부서에 속한 직원 조회
SELECT EMPLOYEE_ID, FIRST_NAME, DEPARTMENT_ID
FROM EMPLOYEES e
WHERE DEPARTMENT_ID IN (
	SELECT DEPARTMENT_ID
	FROM DEPARTMENTS
	WHERE DEPARTMENT_NAME = 'IT');

-- EXISTS 연산자 : 서브쿼리의 결과가 존재하는지 여부를 확인할 때 사용
-- 부서별 평균 급여보다 높은 직원 수 
SELECT E.DEPARTMENT_ID, COUNT(*) 직원수
FROM EMPLOYEES E
WHERE EXISTS(
   SELECT 1		-- 조건을 만족하는 결과가 나오면 TRUE 반환, EXISTS 사용으로 컬럼이 딱히 필요가 없음
   FROM EMPLOYEES E2
   WHERE E2.DEPARTMENT_ID = E.DEPARTMENT_ID
      AND E.SALARY > (	-- 조건 : 부서번호가 같고 급여가 아래 서브쿼리의 값보다 크다면
         SELECT AVG(SALARY)
         FROM EMPLOYEES
         WHERE E.DEPARTMENT_ID = E2.DEPARTMENT_ID
      )
   )
GROUP BY DEPARTMENT_ID;

SELECT DEPARTMENT_ID, AVG(SALARY) FROM EMPLOYEES
GROUP BY DEPARTMENT_ID; --4150

SELECT DEPARTMENT_ID, SALARY FROM EMPLOYEES
WHERE DEPARTMENT_ID = 30;

SELECT * FROM EMPLOYEES;

-- 전체 평균 급여와 부서별 평균 급여 구하기
SELECT AVG(SALARY)
FROM EMPLOYEES;	-- 전체 평균 급여 (1행)

SELECT AVG(SALARY)
FROM EMPLOYEES
GROUP BY DEPARTMENT_ID;	-- 부서별 평균 급여 (12행)

-- 메인쿼리의 결과 행의 수보다 서브쿼리의 행의 수가 많으면 안됨
--SELECT AVG(SALARY), (SELECT * FROM EMPLOYEES)	
--FROM EMPLOYEES;
-- 오류 발생 : 메인쿼리 행 개수 < 서브쿼리 행 개수

SELECT DEPARTMENT_ID, AVG(SALARY), (SELECT AVG(SALARY) FROM EMPLOYEES)
FROM EMPLOYEES
GROUP BY DEPARTMENT_ID;

-- 각 직원의 사원번호, 이름, 급여와 해당 부서의 평균 급여 조회
SELECT DEPARTMENT_ID 사원번호, FIRST_NAME 이름, SALARY 급여,
	(
	SELECT AVG(SALARY)
	FROM EMPLOYEES E2
	WHERE E2.DEPARTMENT_ID = E.DEPARTMENT_ID
	) "부서 평균 급여"
FROM EMPLOYEES E;

-- FROM절 서브쿼리 (공통되는 컬럼을 ON절 뒤에 작성해서 데이터 1차 추출하기)
-- 부서별 평균급여를 계산한 후, 평균 급여보다 높은 직원 조회하기
SELECT e.EMPLOYEE_ID, e.FIRST_NAME, e.SALARY, t.AVG_SALARY
FROM EMPLOYEES e
	JOIN (
		SELECT DEPARTMENT_ID, AVG(SALARY) AVG_SALARY
		FROM EMPLOYEES e2
		GROUP BY DEPARTMENT_ID) t
	ON e.DEPARTMENT_ID  = t.DEPARTMENT_ID
WHERE e.SALARY > t.AVG_SALARY;


